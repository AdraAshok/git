node(){
    
    stage("Git checkout"){
      git url: 'https://github.com/KCTechnologiesDevOps/KCMavenWebProject.git'  
        
    }
    
    stage("Maven Build"){
    def mvnHome = tool name: 'M2_HOME', type: 'maven'
    def mvnCMD = "${mvnHome}/bin/mvn"
    sh "${mvnCMD} clean package"
    }
    stage("Docker Image Build"){
        
     sh "docker build -t kctechnologiesdevops/bacth27practice:1.0 ."
    }
    
    stage("Push Docker Image"){
        
        withCredentials([string(credentialsId: 'docker-pwd1', variable: 'DOCKER_PWD1')]) {
              sh "docker login -u kctechnologiesdevops -p ${DOCKER_PWD1}"
        }
     sh "docker push kctechnologiesdevops/bacth27practice:1.0"
        
    }
    
    
     stage("Remove existing container"){
 	def removeContainer = "docker rm -f KCMavenCntr"
          try{
	sshagent(['ec2-user-pem']) {
   	 sh "ssh -o StrictHostKeyChecking=no ec2-user@172.31.27.145 ${removeContainer}"
	}
          }catch(error){
		sh "echo No contianer exists"
	}

	}
    
    stage("Container Creation"){
        
        def dockerRun = "docker run -itd --name KCMavenCntr -p 8080:8080 kctechnologiesdevops/bacth27practice:1.0"
        sshagent(['ec2-user-pem']) {
              sh "ssh  -o StrictHostKeyChecking=no ec2-user@172.31.27.145 ${dockerRun}"
            }
        
        
    }

    
    
    
}
